<!DOCTYPE html>
<html>

<head>

<title>ReadyMap Packager</title>

<link rel="icon" type="image/x-icon" href="img/favicon.ico" />

<link rel="stylesheet" href="ext/leaflet/leaflet.css" />
<link rel="stylesheet" href="ext/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/style.css">

<script src="ext/leaflet/leaflet-src.js"></script>
<script src="ext/Proj4Leaflet/proj4-compressed.js"></script>
<script src="ext/Proj4Leaflet/proj4leaflet.js"></script>
<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="js/osgearth.js"></script>

<script language="javascript" type="text/javascript">

L.Map.mergeOptions({
    drawExtent: true
});

L.Map.DrawExtent = L.Handler.extend({
    initialize: function (map) {
        this._map = map;
        this._container = map._container;
        this._pane = map._panes.overlayPane;
        this._moved = false;
    },

    addHooks: function () {
        L.DomEvent.on(this._container, 'mousedown', this._onMouseDown, this);
    },

    removeHooks: function () {
        L.DomEvent.off(this._container, 'mousedown', this._onMouseDown);
        this._moved = false;
    },

    moved: function () {
        return this._moved;
    },

    _onMouseDown: function (e) {
        this._moved = false;

        if (!e.ctrlKey || ((e.which !== 1) && (e.button !== 1))) { return false; }

        // Disable dragging.
        this._map.dragging.disable();

        L.DomUtil.disableTextSelection();
        L.DomUtil.disableImageDrag();

        this._startLayerPoint = this._map.mouseEventToLayerPoint(e);

        L.DomEvent
            .on(document, 'mousemove', this._onMouseMove, this)
            .on(document, 'mouseup', this._onMouseUp, this)
            .on(document, 'keydown', this._onKeyDown, this);
    },

    _onMouseMove: function (e) {
        if (!this._moved) {
            this._box = L.DomUtil.create('div', 'leaflet-zoom-box', this._pane);
            L.DomUtil.setPosition(this._box, this._startLayerPoint);

            //TODO refactor: move cursor to styles
            this._container.style.cursor = 'crosshair';
            this._map.fire('drawextentstart');
        }

        var startPoint = this._startLayerPoint,
            box = this._box,

            layerPoint = this._map.mouseEventToLayerPoint(e),
            offset = layerPoint.subtract(startPoint),

            newPos = new L.Point(
                Math.min(layerPoint.x, startPoint.x),
                Math.min(layerPoint.y, startPoint.y));

        L.DomUtil.setPosition(box, newPos);

        this._moved = true;

        // TODO refactor: remove hardcoded 4 pixels
        box.style.width  = (Math.max(0, Math.abs(offset.x) - 4)) + 'px';
        box.style.height = (Math.max(0, Math.abs(offset.y) - 4)) + 'px';
    },

    _finish: function () {
        if (this._moved) {
            this._pane.removeChild(this._box);
            this._container.style.cursor = '';
        }

        L.DomUtil.enableTextSelection();
        L.DomUtil.enableImageDrag();

        L.DomEvent
            .off(document, 'mousemove', this._onMouseMove)
            .off(document, 'mouseup', this._onMouseUp)
            .off(document, 'keydown', this._onKeyDown);
    },

    _onMouseUp: function (e) {

        this._finish();

        var map = this._map,
            layerPoint = map.mouseEventToLayerPoint(e);

        if (this._startLayerPoint.equals(layerPoint)) { return; }

        var bounds = new L.LatLngBounds(
                map.layerPointToLatLng(this._startLayerPoint),
                map.layerPointToLatLng(layerPoint));

        map.fire('drawextentend', {
            bounds: bounds
        });

        map.dragging.enable();
    },

    _onKeyDown: function (e) {
        if (e.keyCode === 27) {
            this._finish();
        }
    }
});

L.Map.addInitHook('addHandler', 'drawExtent', L.Map.DrawExtent);







var extensions =
        [
            "Common|.tif;.tiff;.sid;.ecw;.vrt;.jp2;.j2k;.png;.jpg;.jpeg;.gif;.dem;.dt0;.dt1;.dt2;.adf;.blx;.xlb;.bag;.bmp;.bt;.doq;.hdr;.n1;.ers;.fits;.img;.nitf;.ntf;.toc;.kap;.db;.mbtiles;.xml;.hgt",
            "GeoTIFF/TIFF|.tif;.tiff",
            "MrSID|.sid",
            "ECW|.ecw",
            "VRT|.vrt",
            "JPEG2000|.jp2;.j2k",
            "Image Types|.png;.jpg;.jpeg;.gif",
            ".dem",
            ".dt0",
            ".dt1",
            ".dt2",
            ".adf",
            ".blx",
            ".xlb",
            ".bag",
            ".bmp",
            ".bt",
            ".doq",
            ".hdr",
            ".n1",
            ".ers",
            ".fits",
            ".img",
            ".nitf",
            ".ntf",
            ".toc",
            ".kap",
            ".hgt",
            "SIMDIS DB|.db",
            "MBTiles|.mbtiles",
            "TMS|.xml"
        ];

var extensions_string = extensions.join(",");

var map;
var activeFiles = [];
var activePolygons = [];
var extentPoly;
var startTime;
var completedTiles = 0;
var packager = undefined;

function getFileCount() {
    var count = 0;
    $.each(activeFiles, function(index, file) {
        if (file) {
            count++;
        }
    });

    return count;
}

function addFile(filenames) {
    setSelectedRow();

    var files = filenames.split(",");
    $.each(files, function(index, value) {
        var file = gdal.open(value);
        if (file) {
            file.name = value;
            //$("#files-error").hide();
        }
        // If you select a db file or an mbtiles file we will allow it.
        else if (value.endsWith(".db") || value.endsWith(".mbtiles") || value.endsWith(".xml")) {
            try {

                var tileSource = null;

                if (value.endsWith(".db")) {
                    tileSource = new osgearth.TileSource("db", {
                        "url": value
                    });
                }
                else if (value.endsWith(".mbtiles")) {
                    tileSource = new osgearth.TileSource("mbtiles", {
                        "filename": value
                    });
                }
                // Assume XML files are TMS repositories
                else if (value.endsWith(".xml")) {
                    tileSource = new osgearth.TileSource("tms", {
                        "url": value
                    });
                }

                if (tileSource) {
                    file = {};
                    file.name = value;
                    file.minLat = tileSource.minLat;
                    file.minLon = tileSource.minLon;
                    file.maxLon = tileSource.maxLon;
                    file.maxLat = tileSource.maxLat;
                    file.maxLevel = tileSource.maxLevel;
                    file.projection = tileSource.projection;
                    file.bands = "Unknown";
                    tileSource = null;
                }
            }
            catch(e) {
                alert(e.toString());
            }
        }

        if (file) {
            file.id = activeFiles.length;

            activeFiles.push(file);
            var poly = L.polygon([
                [file.minLat, file.minLon],
                [file.minLat, file.maxLon],
                [file.maxLat, file.maxLon],
                [file.maxLat, file.minLon]
            ], { color: '#0000FF', fillColor: '#0000FF', zIndex: file.id }).addTo( map );
            poly.bringToBack();
            activePolygons.push(poly);
        }
    });

    updateFiles();
    updateZoomLevels();
    updateEstimate();
}

function removeFile(fileid) {
    if (isNaN(fileid) || fileid < 0 || fileid >= activeFiles.length) {
        return;
    }

    $('#data_sources > .file-row[data-fileid="' + fileid + '"').remove();

    map.removeLayer(activePolygons[fileid]);

    activeFiles[fileid] = null;
    activePolygons[fileid] = null;

    setProperties();

    updateZoomLevels();
    updateEstimate();
}

function updateFiles(selectedIndex) {
    $("#data_sources").empty();

    for (var i=activeFiles.length; i >= 0; i--) {
        var file = activeFiles[i];
        if (file) {
            var row = '<div class="file-row' + (i === selectedIndex ? ' selected' : '') + '" data-filename="' + file.name + '" data-fileid="' + file.id + '"><i class="fa fa-remove file-remove action-button"></i> ' + file.name + '</div>';

            $("#data_sources").append(row);
        }
    }
}

function setProperties(file) {
    if (file === undefined) {
        $('#data_props').empty();
    }
    else {
        var output = '<b>' + file.name + '</b>' + '<br><br>' +
                              '<b>Projection:</b> ' + file.projection + '<br><br>' +
                              '<b>Min:</b><br><span class="nowrap">' + file.minLon + ', ' + file.minLat + '</span><br><br>' +
                              '<b>Max:</b><br><span class="nowrap">' + file.maxLon + ', ' + file.maxLat + '</span><br><br>' +
                              '<b>Bands:</b> ' + file.bands + '<br>';
        if (file.size) {
            output += '<b>Size:</b> ' + file.size[0] + ' x ' + file.size[1];
        }

        $('#data_props').html( output );
    }
}

function updateZoomLevels() {
    var groupMax = 0;
    for (var i=activeFiles.length; i >= 0; i--) {
        var file = activeFiles[i];
        if (file) {
            //var minSpan = Math.min(file.size[0], file.size[1]);
            //var tileSize = 256;
            //var maxZoom = Math.ceil(Math.log2((minSpan / tileSize) + 1));

            groupMax = Math.max(groupMax, file.maxLevel);
        }
    }

    $('#output_minzoom').val(0);
    $('#output_maxzoom').val(groupMax >= 0 ? groupMax : 0);
}

function setError(msg) {
    $('#footer').html('<span class="error-msg">' + msg + "</span>");
}

function validateExtents() {
    $('.extent-input').removeClass("inerror");

    var minLat = parseFloat($('#output_minLat').val());
    var minLon = parseFloat($('#output_minLon').val());
    var maxLat = parseFloat($('#output_maxLat').val());
    var maxLon = parseFloat($('#output_maxLon').val());

    if (isNaN(minLat) || minLat < -90.0 ||
        isNaN(minLon) || minLon < -180.0 ||
        isNaN(maxLat) || maxLat > 90.0 ||
        isNaN(maxLon) || maxLon > 180.0) {

        $('.extent-input').addClass("inerror");
        setError("Invalid extents");

        return undefined;
    }

    return { minLat: minLat, minLon: minLon, maxLat: maxLat, maxLon: maxLon };
}

function validateDestination() {
    $('#output_destination').removeClass("inerror");
    var path = $('#output_destination').val();

    //TODO: actually validate that the path is an existing folder
    if (path === undefined || path.length === 0) {
        $('#output_destination').addClass("inerror");
        setError("Invalid destination");
        return undefined;
    }

    return path;
}

function validateZoomLevels() {
    $('.zoom-input').removeClass("inerror");

    var min = parseInt($('#output_minzoom').val());
    var max = parseInt($('#output_maxzoom').val());

    if (isNaN(min) || isNaN(max) || min < 0 || min > max) {
        $('.zoom-input').addClass("inerror");
        setError("Invalid zoom levels");
        return undefined;
    }

    return {minLevel: min, maxLevel: max};
}

function validateNumCores() {
    $('#output_cores').removeClass("inerror");
    var cores = parseInt($('#output_cores').val());
    if (isNaN(cores) || cores < 1) {
        $('#output_cores').addClass("inerror");
        setError("Invalid number of cores");
        return undefined;
    }

    return cores;
}

function validateLayerName() {
    $('#layer-name').removeClass("inerror");
    var layerName = $("#layer-name").val().trim();
    if (layerName.length == 0) {
        $("#layer-name").addClass("inerror");
        setError("Invalid layer name");
        return undefined;
    }
    return layerName;
}

function onLoadClick() {
    osgearth.openFileDialog({
        onSuccess: function(files) {
           addFile( files );
        },
        onFailure: function(error_code, error_message) {
            if (error_message) {
                setError(error_message);
            }
        }
    },
    true,
    extensions_string);
}

function onMoveFileClick(dirInc) {
    var selectedRow = $('#data_sources > .file-row.selected')[0];
    if (selectedRow !== undefined) {
        var fileid = $(selectedRow).data("fileid");

        var swapId = -1;
        for (var i=fileid + dirInc; i >= 0 && i < activeFiles.length; i += dirInc) {
            var file = activeFiles[i];
            if (file) {
                swapId = i;
                break;
            }
        }

        if (swapId >= 0) {
            var selectedFile = activeFiles[fileid];
            var selectedPoly = activePolygons[fileid];

            activeFiles[fileid] = activeFiles[swapId];
            activeFiles[fileid].id = fileid;
            activePolygons[fileid] = activePolygons[swapId];

            selectedFile.id = swapId;
            activeFiles[swapId] = selectedFile;
            activePolygons[swapId] = selectedPoly;

            updateFiles(swapId);
        }
    }
}

function moveFileToTop() {
    var selectedRow = $('#data_sources > .file-row.selected')[0];
    if (selectedRow !== undefined) {
        var fileid = $(selectedRow).data("fileid");
        var finalIndex = activeFiles.length - 1;
        if (fileid >= 0 && fileid < finalIndex) {
            var selectedFile = activeFiles[fileid];
            var selectedPoly = activePolygons[fileid];

            for (var i=fileid; i < finalIndex; i += 1) {
                activeFiles[i] = activeFiles[i + 1];
                if (activeFiles[i]) activeFiles[i].id = i;
                activePolygons[i] = activePolygons[i + 1];
            }

            activeFiles[finalIndex] = selectedFile;
            activeFiles[finalIndex].id = finalIndex;
            activePolygons[finalIndex] = selectedPoly;

            updateFiles(finalIndex);
        }
    }
}

function moveFileToBottom() {
    var selectedRow = $('#data_sources > .file-row.selected')[0];
    if (selectedRow !== undefined) {
        var fileid = $(selectedRow).data("fileid");
        var finalIndex = 0;
        if (fileid < activeFiles.length && fileid > finalIndex) {
            var selectedFile = activeFiles[fileid];
            var selectedPoly = activePolygons[fileid];

            for (var i=fileid; i > finalIndex; i -= 1) {
                activeFiles[i] = activeFiles[i - 1];
                if (activeFiles[i]) activeFiles[i].id = i;
                activePolygons[i] = activePolygons[i - 1];
            }

            activeFiles[finalIndex] = selectedFile;
            activeFiles[finalIndex].id = finalIndex;
            activePolygons[finalIndex] = selectedPoly;

            updateFiles(finalIndex);
        }
    }
}

function getPackageDestination() {
    var output = $( "input:radio[name=output]:checked" ).val();

    if (output === "mbtiles") {
        osgearth.saveFileDialog({
            onSuccess: function(file) {
               doPackage(file);
            },
            onFailure: function(error_code, error_message) {
            }
        },
        "MBTiles|.mbtiles");
    }
    else {
        osgearth.openFolderDialog({
            onSuccess: function(file) {
               doPackage(file);
            },
            onFailure: function(error_code, error_message) {
            }
        });
    }
}

function onExtentsClick() {
    var minLat = undefined;
    var minLon = undefined;
    var maxLat = undefined;
    var maxLon = undefined;

    $.each(activeFiles, function(index, file) {
        if (file) {
            if (minLat === undefined || file.minLat < minLat) {
                minLat = file.minLat;
            }
            if (minLon === undefined || file.minLon < minLon) {
                minLon = file.minLon;
            }
            if (maxLat === undefined || file.maxLat > maxLat) {
                maxLat = file.maxLat;
            }
            if (maxLon === undefined || file.maxLon > maxLon) {
                maxLon = file.maxLon;
            }
        }
    });

    if (minLat !== undefined && minLon !== undefined && maxLat !== undefined && maxLon !== undefined) {
        $('#output_minLat').val(minLat);
        $('#output_minLon').val(minLon);
        $('#output_maxLat').val(maxLat);
        $('#output_maxLon').val(maxLon);

        updateExtents();
    }
}

function onPackageClick() {
    var filenames = [];
    $.each(activeFiles, function(index, file) {
        if (file) {
            filenames.push(file.name);
        }
    });

    if (filenames.length === 0) {
        setError("No files have been selected for packaging");
        return false;
    }

    var extents = validateExtents();
    if (extents === undefined) {
        return false;
    }

    var zoom = validateZoomLevels();
    if (zoom === undefined) {
        return false;
    }

    var cores = validateNumCores();
    if (cores === undefined) {
        return false;
    }

    var layerName = validateLayerName();
    if (layerName === undefined) {
        return false;
    }

    getPackageDestination();
}

function doPackage(path) {
    if (path === undefined) {
        return false;
    }

    var filenames = [];
    $.each(activeFiles, function(index, file) {
        if (file) {
            filenames.push(file.name);
        }
    });

    if (filenames.length === 0) {
        setError("No files have been selected for packaging");
        return false;
    }

    var tileSources = [];
    $.each(filenames, function(index, file) {

        var tileSource = null;

        // Use the GDAL driver by default.
        var driver = "gdal";
        // If we are loading a DB file use the DB driver.
        if (file.endsWith(".db")) {
            tileSource = new osgearth.TileSource("db", {
                "url": file
            });
        }
        else if (file.endsWith(".mbtiles")) {
            tileSource = new osgearth.TileSource("mbtiles", {
                "filename": file
            });
        }
        // Assume XML files are TMS repositories
        else if (file.endsWith(".xml")) {
            tileSource = new osgearth.TileSource("tms", {
                "url": file
            });
        }
        else {
            tileSource = new osgearth.TileSource("gdal", {
                "url": file
            });
        }

        /*
        // Example of packaging ReadyMap from a TMS source.
        var tileSource = new osgearth.TileSource("tms", {
            "url": "http://www.readymap.org/readymap/tiles/1.0.0/22/"
        })
        */
        tileSources.push(tileSource);
    });

    var extents = validateExtents();
    if (extents === undefined) {
        return false;
    }

    var zoom = validateZoomLevels();
    if (zoom === undefined) {
        return false;
    }

    var cores = validateNumCores();
    if (cores === undefined) {
        return false;
    }

    var layerName = validateLayerName();
    if (layerName === undefined) {
        return false;
    }

    var ext = $( "input:radio[name=format]:checked" ).val();

    var output = $( "input:radio[name=output]:checked" ).val();

    var profile = $( "input:radio[name=profile]:checked" ).val();

    $('#out_text').html("0%");

    $('#out_progress').show();

    setSelectedRow();
    updateFiles();
    $(".action-button").addClass("disabledbutton");

    startTime = new Date();
    var jpeg_quality = parseInt($("#compression").val());
    packager = osgearth.package({
        //filenames: filenames,
        tilesources: tileSources,
        layer: layerName,
        destination: path,
        extension: ext,
        output: output,
        profile: profile,
        min_level: zoom.minLevel,
        max_level: zoom.maxLevel,
        cores: cores,
        jpeg_quality: jpeg_quality,
        extents: [extents.minLon, extents.minLat, extents.maxLon, extents.maxLat],
        progress: function( current, total, currentStage, totalStages, msg) {
            var message = "Completed " + current + " tiles...";
            var percentComplete = Math.min((current / total) * 100.0, 98.0).toFixed();
            $('#out_progressbar').css({"height": percentComplete + "%"});
            $('#out_text').html(percentComplete + "%");
            $('#footer').html(message);
            completedTiles = current;
        },
        complete: function() {
            $(".action-button").removeClass("disabledbutton");
            var endTime = new Date();
            var seconds = (endTime.getTime() - startTime.getTime())/1000.0;

            $('#out_progressbar').css({"height": "100%"});
            $('#out_text').html("100%");

            var message = "Packaging complete!\n\n" +
                          "Created " + completedTiles + " tiles in " + prettyPrintTime( seconds );

            alert(message);

            $('#out_progressbar').css({"height": "0%"});
            $('#out_progress').hide();
            completedTiles = 0;

            updateEstimate();
        }
    });
}

function onPackageCanceled(){
    if (packager) {
        osgearth.cancelPackage(packager);
    }
}

function updateDatasetOptions() {
    var type = $( "input:radio[name=dataset_type]:checked" ).val();
    if (type === "image") {
        $('input.img-type').attr("disabled", false);
        $('input.elev-type').attr("disabled", true);
        $('input[name=format][value="png"]').prop('checked', true);
    }
    else {
        $('input.elev-type').attr("disabled", false);
        $('input.img-type').attr("disabled", true);
        $('input[name=format][value="tif16"]').prop('checked', true);
    }
}

function updateExtents() {
    var extents = validateExtents();

    if (extents !== undefined) {
        map.removeLayer(extentPoly);

        extentPoly = L.polyline([
            [extents.minLat, extents.minLon],
            [extents.minLat, extents.maxLon],
            [extents.maxLat, extents.maxLon],
            [extents.maxLat, extents.minLon],
            [extents.minLat, extents.minLon]
        ], { color: '#FF0000', zIndex: -9999 }).addTo( map );

        extentPoly.bringToFront();

        updateEstimate();
    }
}

function prettyPrintTime(seconds) {

    var s = seconds;

    var days = Math.floor(s / 86400);
    s = s - (days * 86400);
    var hours = Math.floor(s / 3600);
    s = s - (hours * 3600);
    var minutes = Math.floor(s / 60);
    s = s - (minutes * 60);

    var result = "";
    if (days > 0) {
        result = result + days.toFixed().toString() + " days ";
    }

    if (hours > 0) {
        result = result + hours.toFixed().toString() + " hours ";
    }

    if (minutes > 0) {
        result = result + minutes.toFixed().toString() + " min ";
    }

    if (seconds > 0) {
        result = result + s.toFixed().toString() + " s";
    }

    return result;
}

/**
 * Prints a nice representation of a file size given the size in bytes
 **/
function prettyFileSize(bytes) {
    var units = ["B", "KB", "MB", "GB"];
    var value = bytes;
    var i = 0;
    for (i = 0; i < units.length; i++) {
        if (value > 1024) {
            value /= 1024;
        } else {
            break;
        }
    }
    //return value.toFixed(2) + units[i];
    return Math.floor(value) + units[i];
}

function updateEstimate() {
    /*
    var extents = validateExtents();
    if (extents === undefined) {
        return false;
    }

    var zoom = validateZoomLevels();
    if (zoom === undefined) {
        return false;
    }

    var cores = validateNumCores();
    if (cores === undefined) {
        return false;
    }

    var est = osgearth.estimate({
        min_level: zoom.minLevel,
        max_level: zoom.maxLevel,
        extents: [extents.minLon, extents.minLat, extents.maxLon, extents.maxLat]
    });

    var message = "Package estimate: ~" + est.tiles + " tiles in " + prettyPrintTime(est.seconds / cores) + " and use " + prettyFileSize(est.size * 1000000);
    */

    var message = "Add data sources to get started";

    var count = getFileCount();
    if (count > 0) {
        message = "Click the Package button to begin tile generation";
    }

    $('#footer').html(message);
}

function setSelectedRow(thisrow) {
    $('#data_sources > .file-row').not(thisrow).each(function() {
        $(this).removeClass("selected");
    });

    $.each(activePolygons, function(index, value) {
        if (value) {
            value.setStyle({color: '#0000FF', fillColor: '#0000FF'});
        }
    });

    $('#data_header .file-act').removeClass("active");

    setProperties();

    if (thisrow !== undefined) {
        $(thisrow).addClass("selected");

        var fileid = $(thisrow).data("fileid");
        activePolygons[fileid].setStyle({color: '#FF00FF', fillColor: '#FF00FF'});

        $('#data_header .file-act').addClass("active");

        setProperties(activeFiles[$(thisrow).data("fileid")]);
    }
}

$(function() {
    var crs = new L.Proj.CRS('EPSG:4326',
        "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",
        {
                resolutions: [
                    0.7031250000000000000000000,
                    0.3515625000000000000000000,
                    0.1757812500000000000000000,
                    0.0878906250000000000000000,
                    0.0439453125000000000000000,
                    0.0219726562500000000000000,
                    0.0109863281250000000000000,
                    0.0054931640625000000000000,
                    0.0027465820312500000000000,
                    0.0013732910156250000000000,
                    0.0006866455078125000000000
                ],
                origin: [-180.0, 90.0],
                bounds: L.bounds([-180.0, -90.0], [180.0, 90.0])
        });

    map = L.map('map',  { crs: crs, attributionControl: false, zoom: 1, center: [0.0, 0.0] });
    map.on("drawextentend", function(e) {
        var minLon = e.bounds.getWest();
        var minLat = e.bounds.getSouth();
        var maxLon = e.bounds.getEast();
        var maxLat = e.bounds.getNorth();

        $('#output_minLat').val(minLat);
        $('#output_minLon').val(minLon);
        $('#output_maxLat').val(maxLat);
        $('#output_maxLon').val(maxLon);

        updateExtents();
    });

    // Don't ask me why, but we have to disable dragging and then re-enable it at the end of this function to make it so the DrawExtent handler can disable and enable dragging properly.
    map.dragging.disable();

    /*L.tileLayer('http://readymap.org/readymap/tiles/1.0.0/7/{z}/{x}/{y}.png', {
      continuousWorld: false,
      noWrap: true,
      minZoom: 1,
      maxZoom: 14,
      tms: true
    }).addTo(map);*/

    var options = {
        minZoom: 0,
        maxZoom: 7,
        maxNativeZoom: 3,
        opacity: 1.0,
        tms: true,
        continuousWorld: false,
        noWrap: true
    };

    var world = new L.TileLayer("data/world/{z}/{x}/{y}.jpg", options);
    map.addLayer(world);

    extentPoly = L.polyline([
        [-90.0, -180.0],
        [-90.0, 180.0],
        [90.0, 180.0],
        [90.0, -180.0],
        [-90.0, -180.0]
    ], { color: '#FF0000', zIndex: -9999 }).addTo( map );

    extentPoly.bringToFront();

    // set up event bindings
    $('#load_button').click(onLoadClick);

    $('#filedown_button').click(function() {
        onMoveFileClick(-1);
    });

    $('#fileup_button').click(function() {
        onMoveFileClick(1);
    });

    $('#filetop_button').click(function() {
        moveFileToTop();
    });

    $('#filebottom_button').click(function() {
        moveFileToBottom();
    });

    $('#zoom_button').click(function() {
        updateZoomLevels();
    });

    $('input[name="dataset_type"]').change(function() {
        updateDatasetOptions();
    });

    $('.extent-input').change(function() {
        updateExtents();
    });

    $('.zoom-input').change(function() {
        updateEstimate();
    });

    $('#out_button').click(onPackageClick);

    $('#out_cancel').click(onPackageCanceled);

    $('#out_progress').click(function(event) {
        event.stopPropagation();
    })

    $('#data_sources').on('click', '.file-row', function() {
        event.stopPropagation();
        setSelectedRow(this);
    });

    $('#data_sources').click(function(event) {
        if ($(event.target).is('#data_sources')) {
            setSelectedRow();
        }
    })

    $('#data_sources').on('dblclick', '.file-row', function() {
        var file = activeFiles[$(this).data("fileid")];
        if (file !== undefined) {
            map.fitBounds([
                [file.minLat, file.minLon],
                [file.maxLat, file.maxLon]
            ]);
        }
    });

    $('#data_sources').on('click', '.file-remove', function(event) {
        event.stopPropagation();
        removeFile($(this).parent().data("fileid"));
    });

    $("#compression").on("change input", function() {
        $("#compression-text").html($("#compression").val() + "%");
    });

    map.dragging.enable();
});


</script>

</head>

<body>
    <div id="leftbar">
        <!--<div id="leftbar_buttons">
            <input type="button" id="load_button" class="flat-button" value="ADD DATA" onClick="onLoadClick()"/>
        </div>-->
        <div id="data_header" class="box-header">
            Data Sources<span class="pushright"><i id="filebottom_button" class="action-button fa fa-angle-double-down file-act" title="Move to bottom"></i><i id="filedown_button" class="action-button fa fa-angle-down file-act" title="Move down"></i><i id="action-button fileup_button" class="action-button fa fa-angle-up file-act" title="Move up"></i><i id="filetop_button" class="action-button fa fa-angle-double-up file-act" title="Move to top"></i><i id="load_button" class="action-button fa fa-plus" title="Add data source"></i></span>
        </div>
        <div id="data_sources" class="layer-box"></div>
        <div id="props_header" class="box-header">
            Properties
        </div>
        <div id="data_props" class="layer-box"></div>
    </div>

    <div id="map"></div>
    <div id="bottombar">
        <div id="output_header" class="box-header">
            Package Options
        </div>
        <div id="output_props" class="layer-box">
            <div>
                <label for="layer-name">Layer name:</label><input type="text" id="layer-name" value="layer"></input>
            </div>

            <div class="table">
                <div class="table-row">
                    <div class="table-cell">
                    </div>
                    <div class="table-cell border-clear">
                        <b>File Format</b>&nbsp<i id="format_trigger" class="fa fa-question-circle accent-mark tooltipped">
                            <div class="tooltip">
                                <p><b>PNG</b> - Used for imagery that will contain transparency</p>
                                <p><b>JPEG</b> - Used for imagery that will cover the entire globe. Does not support trnasparency</p>
                                <p><b>TIFF (16-bit)</b> - Used for elevation data. Produces smaller files than 32-bit TIFF</p>
                                <p><b>TIFF (32-bit)</b> - Used for elevation data. Produces larger files but will be more accurate for data with sub-meter resolution</p>
                            </div>
                        </i>
                    </div>
                    <div class="table-cell">
                        <b>Package Type</b>
                    </div>
                    <div class="table-cell">
                        <b>Profile</b>
                    </div>
                </div>
                <div class="table-row">
                    <div class="table-cell">
                        <input type="radio" name="dataset_type" value="image" checked="checked"> Imagery
                    </div>
                    <div class="table-cell border-clear">
                        <input type="radio" name="format" value="png" class="img-type" checked="checked"> PNG<br>
                        <input type="radio" name="format" value="jpg" class="img-type"> JPEG<br>
                    </div>
                    <div class="table-cell">
                        <input type="radio" name="output" value="tms" checked="checked"> TMS<br>
                        <input type="radio" name="output" value="mbtiles"> MBTiles<br>
                    </div>
                    <div class="table-cell">
                        <input type="radio" name="profile" value="global-geodetic" checked="checked">Global Geodetic<br>
                        <input type="radio" name="profile" value="spherical-mercator">Spherical Mercator<br>
                    </div>
                </div>
                <div class="table-row">
                    <div class="table-cell">
                        <input type="radio" name="dataset_type" value="elevation"> Elevation
                    </div>
                    <div class="table-cell border-clear">
                        <input type="radio" name="format" value="tif16" class="elev-type" disabled> TIFF (16-bit)<br>
                        <input type="radio" name="format" value="tif32" class="elev-type" disabled> TIFF (32-bit)
                    </div>
                    <div class="table-cell">
                    </div>
                </div>
                <div class="table-row">
                    Compression<input type="range" id="compression" value="75"><span id="compression-text">75%</span>
                </div>

            </div>

            <div id="output_left" class="table">
                <div class="table-row">
                    <div class="table-cell">
                        <b>Extents</b>
                    </div>
                </div>
                <div class="table-row">
                    <div class="table-cell nowrap">
                        <div class="table">
                            <div class="table-row">
                                <div class="table-cell">
                                    Min
                                </div>
                                <div class="table-cell">
                                    <input id="output_minLon" class="extent-input" type="text" value="-180.0"/>
                                </div>
                                <div class="table-cell">
                                    <input id="output_minLat" class="extent-input" type="text" value="-90.0"/>
                                </div>
                            </div>
                            <div class="table-row">
                                <div class="table-cell">
                                    Max
                                </div>
                                <div class="table-cell">
                                    <input id="output_maxLon" class="extent-input" type="text" value="180.0"/>
                                </div>
                                <div class="table-cell">
                                    <input id="output_maxLat" class="extent-input" type="text" value="90.0"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-row">
                    <div class="table-cell nowrap">
                        <b>Zoom Levels</b> <input id="output_minzoom" class="zoom-input" type="text" value="0"/> to <input id="output_maxzoom" class="zoom-input" type="text" value="0"/><span id="zoom_button" class="font-button" title="Reset to data range"><i class="fa fa-refresh"></i></span>
                    </div>
                </div>
            </div>

            <div id="cores_div">
                Number of processor cores to use during packaging <input id="output_cores" type="text" value="1"/>
            </div>
        </div>
        <div id="out_button" class="flat-button">
            <div id="out_progress">
                <div id="out_progressbar"></div>
                <div id="out_cancel"><i class="fa fa-remove"></i></div>
                <div id="out_textwrap"><span id="out_text">0%</span></div>
            </div>
            <i class="fa fa-share"></i><br>
            Package
        </div>
    </div>
    <div id="footer">Add data sources to get started</div>

    <div id="logo_div"><img src="./img/pelican.png" title="Pelican Mapping"></div>

</body>

</html>
