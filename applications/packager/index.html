<!DOCTYPE html>
<html lang="en">

<head>

    <title>Pelican Map Slicer</title>

    <link rel="stylesheet" type="text/css" href="css/packager.css">
    <script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="js/packager.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <script src="../../js/osgearth.js"></script>


    <style>
        body, html {
            width: 100%;
            height: 100%;
            margin: 0px;
        }

        .page {
            position: absolute;
            left: 0px;
            right: 0px;
            top: 110px;
            bottom: 0px;
        }

        .clearfix {
            overflow: auto;
        }

        .header {
        }

        .thumbnail {
            width: 50px;
            height: 50px;
            padding: 0px;
            margin: 0px;
        }

        .page-footer {
            float:right;
        }

        .zoom-input {
            width: 50px;
        }

        .projection {
            width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;            
        }

    </style>

    <script type="text/javascript">

        function addFile(filename) {
            var file = gdal.open(filename);
            if (file) {
                var row = '<tr class="file-row" data-filename="' + filename + '">' +
                          '<td>' + 
                          '<button type="button" class="del-button btn btn-danger btn-sm">' +
                          '    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>' +
                          '</button>' +
                          '</td>' +
                          '<td>' + filename + '</td>' +
                          '<td>' + file.bands + '</td>' +
                          '<td>' + file.size[0] + "x" + file.size[1] + '</td>' +
                          '</tr>';

                $("#file-table").append(row);
            }
            else {
                alert("Failed to open " + filename);
            }
        }


        function prettyPrintTime(seconds) {

            var s = seconds;

            var days = Math.floor(s / 86400);
            s = s - (days * 86400);
            var hours = Math.floor(s / 3600);
            s = s - (hours * 3600);
            var minutes = Math.floor(s / 60);
            s = s - (minutes * 60);

            var result = "";
            if (days > 0) {
                result = result + days.toFixed().toString() + " days ";
            }

            if (hours > 0) {
                result = result + hours.toFixed().toString() + " hours ";
            }

            if (minutes > 0) {
                result = result + minutes.toFixed().toString() + " min ";
            }

            if (seconds > 0) {
                result = result + s.toFixed().toString() + " s";
            }

            return result;
        }

        var extensions = 
        [
            ".sid",
            "*.ecw",
            "*.vrt",
            "*.jp2",
            "*.j2k",
            "*.tiff",
            "*.png",
            "*.jpg",
            "*.jpeg",
            "*.dem",
            "*.dt0",
            "*.dt1",
            "*.dt2",
            "*.adf",
            "*.blx",
            "*.xlb",
            "*.bag",
            "*.bmp",
            "*.bt",
            "*.doq",
            "*.hdr",
            "*.n1",
            "*.ers",
            "*.fits",
            "*.gif",
            "*.img",
            "*.nitf",
            "*.ntf",
            "*.toc",
            "*.kap"
        ];

        var extensions_string = extensions.join(";");

        $(function() {

            $("#add-files-button").click(function() {
                osgearth.openFileDialog({
                    onSuccess: function(file) {
                       addFile( file );
                    },
                    onFailure: function(error_code, error_message) {

                    }
                },
                false,
                extensions_string);
            });     
            
            // Remove a row if the del button is clicked.
            $("body").on("click", ".del-button", function(e) {
               $(this).parent().parent().remove();
            });

            $("#browse").click(function() {
                osgearth.openFolderDialog({
                    onSuccess: function(file) {
                       $("#destination").val(file);
                    },
                    onFailure: function(error_code, error_message) {

                    }
                });
            });     

            $("#next-1").click(function() {
                $("#page-2").show();
                $("#page-1").hide();
            });

            $("#prev-2").click(function() {
                $("#page-2").hide();
                $("#page-1").show();
            });

            $("#next-2").click(function() {

                // Collect all the files that have a data-filename attribute
                var filenames = [];
                $(".file-row").each(function() {
                   var filename = $(this).data("filename");        
                   if (filename) {
                    filenames.push( filename );
                   }            
                });

                // Get the min/max levels
                var minLevel = parseInt($("#min-level").val());
                var maxLevel = parseInt($("#max-level").val());

                // Get the output directory
                var destination = $("#destination").val();

                // Get the extension
                var ext = $( "input:radio[name=format]:checked" ).val();

                var cores = parseInt($("#cores").val());

                var startTime = new Date();

                var completedTiles = 0;

                osgearth.package({
                    filenames: filenames,
                    destination:  destination,
                    extension: ext,
                    min_level: minLevel,
                    max_level: maxLevel,
                    cores: cores,
                    progress: function( current, total, currentStage, totalStages, msg) {
                        var message = "Completed " + current + " of " + total + " tiles";
                        var percentComplete = ((current / total) * 100.0).toFixed();
                        $("#progress-bar").css({"width": percentComplete + "%"});
                        $("#percent-complete").html(percentComplete + "%");
                        $("#progress-message").html(message);
                        completedTiles = current;
                    },
                    complete: function() {
                        var endTime = new Date();
                        var seconds = (endTime.getTime() - startTime.getTime())/1000.0;

                        $("#progress-bar").css({"width": "100%"});
                        $("#percent-complete").html("100%");
                        var message = "<h3>Tiling complete!</h3>" +
                                      "Created " + completedTiles + " in " + prettyPrintTime( seconds ) + "<br/>" +
                                      "Your tiles are located at <b>" + destination + "</b>";
                        $("#progress-message").html(message).addClass("alert alert-success");
                    }
                });

                $("#page-3").show();
                $("#page-2").hide();
            });

            

        });
    </script>

</head>

<body>

    <div class="container">
        <div class="header">
            <img src="img/logo.png"></img>
        </div>

        <div id="page-1" class="clearfix">
           <h1> Select files to tile</h1>

           <button id="add-files-button" class="btn btn-primary btn-lg">Add file</button>
           <table id="file-table" class="table table-striped">
                <thead>
                    <th style="width: 50px;"></th>
                    <th>Filename</th>
                    <th>Bands</th>
                    <th>Dimensions</th>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="page-footer clearfix">
                <button id="next-1" class="btn btn-primary">Next</button>
            </div>
        </div>

        <div id="page-2" class="clearfix" style="display:none">

            <h1>Export options</h1>

            <h4>Destination</h4>

            <input type="text" id="destination"></input> <button id="browse" class="btn">Browse</button>

            <hr/>



            <h4>Zoom levels</h4>
            <input id="min-level" class="zoom-input" type="text" value="0"></input> to <input id="max-level" class="zoom-input" type="text" value="10"></input>
           
            <hr/>

            <h4>Format</h4>

            <div class="radio">
                <label>
                    <input type="radio" name="format" id="format-png" value="png" checked>
                    <b>PNG</b> - Use for imagery that will contain transparency.
                </label>
            </div>

            <div class="radio">
                <label>
                    <input type="radio" name="format" id="format-jpg" value="jpg">
                    <b>JPEG</b> - Use for imagery that will cover the entire globe.  Does not support transparency.
                </label>
            </div>

            <div class="radio">
                <label>
                    <input type="radio" name="format" id="format-tif16" value="tif16">
                    <b>TIFF (16-bit)</b> - Used for elevation data.  Produces smaller files than 32 bit tiff.
                </label>
            </div>

            <div class="radio">
                <label>
                    <input type="radio" name="format" id="format-tif32" value="tif32">
                    <b>TIFF (32-bit)</b> - Used for elevation data.  Produces larger tiles than 16 bit but will be more accurate for data with sub meter resolution..
                </label>
            </div>


            <hr/>

            <h4>Number of cores to use</h4>
            <input id="cores" type="text" value="1"/>

            <div class="page-footer">
                <button id="prev-2" class="btn">Go back</button>
                <button id="next-2" class="btn btn-primary">Export</button>
            </div>

      
        </div>

        <div id="page-3" class="clearfix" style="display:none">
            <h1>Creating tiles...</h1>
            <div class="progress">
               <div id="progress-bar" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
               <span id="percent-complete">0% Complete</span>
              </div>
            </div>
            <h3 id="progress-message">Progress</h3>
        </div>

    </div>
</body>

</html>
